{
  "action_id": "bidding.restore_previous",
  "title": "Restaurar estratégia/alvo anterior (rollback)",
  "description": "Restaura a configuração anterior de lances (estratégia e/ou alvo) usando o snapshot salvo na última mudança.",
  "entity_types": ["campaign"],
  "params": {
    "restore_of_execution_id": {
      "type": "string",
      "required": false,
      "description": "ID da execução original a ser revertida; se ausente, reverte a última mudança de bidding desta campanha (LIFO)."
    },
    "steps": {
      "type": "integer",
      "required": false,
      "description": "Quantos passos voltar na pilha de mudanças (LIFO). Default: 1.",
      "min": 1,
      "max": 3
    }
  },
  "eligibility": [
    "campaign_status == 'ENABLED'",
    "has_rollback_snapshot == true"
  ],
  "preconditions": [
    "not recent_change('bidding', 1)",
    "rollback_snapshot_age_days <= 14"
  ],
  "guardrails": [
    "previous_state exists",
    "supports_strategy(previous_state.bidding_strategy_type)",
    "if previous_state.bidding_strategy_type == 'TARGET_CPA'  then previous_state.target_cpa  > 0",
    "if previous_state.bidding_strategy_type == 'TARGET_ROAS' then previous_state.target_roas > 0",
    "if previous_state.bidding_strategy_type == 'TARGET_CPA'  then daily_budget >= 2 * previous_state.target_cpa",
    "NEW_STATE != CURRENT_STATE",
    "not is_portfolio_conflict(previous_state)"
  ],
  "rollback": {
    "capture_fields": ["bidding_strategy_type", "target_cpa", "target_roas"],
    "ttl_days": 14
  },
  "kpi_target": "recover_performance",
  "reversibility": 0.95,
  "effort": 0.2,
  "risk": 0.2,
  "api_mapping": {
    "resource": "Campaign",
    "operation": "mutate",
    "fields": ["bidding_strategy_type", "target_cpa_micros", "target_roas"]
  },
  "cooldown_days": 5,
  "conflicts_with": ["bidding.strategy_change", "bidding.target_adjust"],
  "can_batch": false,
  "eval": {
    "window_days": 7,
    "lag_days": 3,
    "metrics": ["delta_roas", "delta_cpa"],
    "success_rules": ["delta_roas >= 0.00", "or", "delta_cpa <= 0.00"],
    "min_sample": "clicks_7d >= 80"
  },
  "version": "1.0.0"
}
